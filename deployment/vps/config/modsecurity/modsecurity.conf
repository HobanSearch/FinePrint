# ModSecurity Configuration for Fine Print AI
# Based on OWASP ModSecurity Core Rule Set

# Enable ModSecurity
SecRuleEngine On

# Process request body
SecRequestBodyAccess On

# Maximum request body size (100MB for document uploads)
SecRequestBodyLimit 104857600
SecRequestBodyNoFilesLimit 131072

# Store up to 128KB of request body in memory
SecRequestBodyInMemoryLimit 131072

# Process response body
SecResponseBodyAccess Off
SecResponseBodyMimeType "text/plain text/html text/xml application/json"
SecResponseBodyLimit 524288

# Temporary directory for file uploads
SecTmpDir /tmp/
SecDataDir /var/cache/modsecurity/

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsecurity/modsec_audit.log

# Debug logging
SecDebugLog /var/log/modsecurity/modsec_debug.log
SecDebugLogLevel 3

# Default action
SecDefaultAction "phase:1,deny,log,status:403"

# Configure detection modes
SecArgumentSeparator &
SecCookieFormat 0

# Unicode mapping
SecUnicodeMapFile unicode.mapping 20127

# Process multipart/form-data
SecRequestBodyAccess On
SecRule REQBODY_ERROR "!@eq 0" \
    "id:200001,phase:2,t:none,log,deny,status:400,msg:'Failed to parse request body.',severity:2"

SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
    "id:200002,phase:2,t:none,log,deny,status:400,msg:'Multipart request body failed strict validation.',severity:2"

# Paranoia Level (1-4, higher = more false positives but better security)
SecAction \
    "id:900000,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.paranoia_level=2"

# Anomaly scoring threshold
SecAction \
    "id:900001,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.inbound_anomaly_score_threshold=10,\
    setvar:tx.outbound_anomaly_score_threshold=5"

# HTTP policy settings
SecAction \
    "id:900002,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.allowed_methods=GET HEAD POST OPTIONS PUT DELETE PATCH,\
    setvar:tx.allowed_request_content_type=application/x-www-form-urlencoded|multipart/form-data|application/json|application/xml|text/xml|text/plain,\
    setvar:tx.allowed_http_versions=HTTP/1.0 HTTP/1.1 HTTP/2.0,\
    setvar:tx.restricted_extensions=.asa/ .asax/ .ascx/ .axd/ .backup/ .bak/ .bat/ .cdx/ .cer/ .cfg/ .cmd/ .com/ .config/ .conf/ .cs/ .csproj/ .csr/ .dat/ .db/ .dbf/ .dll/ .dos/ .htr/ .htw/ .ida/ .idc/ .idq/ .inc/ .ini/ .key/ .licx/ .lnk/ .log/ .mdb/ .old/ .pass/ .pdb/ .pol/ .printer/ .pwd/ .resources/ .resx/ .sql/ .sys/ .vb/ .vbs/ .vbproj/ .vsdisco/ .webinfo/ .xsd/ .xsx/,\
    setvar:tx.restricted_headers=/proxy/ /lock-token/ /content-range/ /if/"

# DOS Protection
SecAction \
    "id:900003,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.dos_burst_time_slice=60,\
    setvar:tx.dos_counter_threshold=100,\
    setvar:tx.dos_block_timeout=600"

# GeoIP settings (optional)
# SecGeoLookupDB /usr/share/GeoIP/GeoLiteCity.dat
# SecAction \
#     "id:900004,\
#     phase:1,\
#     nolog,\
#     pass,\
#     t:none,\
#     setvar:tx.high_risk_country_codes=CN RU KP"

#############################################
# CUSTOM RULES FOR FINE PRINT AI
#############################################

# Rule 1000: Block SQL Injection Attempts
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS|!REQUEST_HEADERS:Referer \
    "@detectSQLi" \
    "id:1000,\
    phase:2,\
    block,\
    msg:'SQL Injection Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-sqli',\
    tag:'OWASP_CRS',\
    tag:'OWASP_CRS/WEB_ATTACK/SQL_INJECTION',\
    severity:'CRITICAL',\
    setvar:'tx.anomaly_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.sql_injection_score=+%{tx.critical_anomaly_score}'"

# Rule 1001: Block XSS Attempts
SecRule REQUEST_URI|ARGS|REQUEST_HEADERS|!REQUEST_HEADERS:Referer \
    "@detectXSS" \
    "id:1001,\
    phase:2,\
    block,\
    msg:'XSS Attack Detected',\
    logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xss',\
    tag:'OWASP_CRS',\
    tag:'OWASP_CRS/WEB_ATTACK/XSS',\
    severity:'CRITICAL',\
    setvar:'tx.anomaly_score=+%{tx.critical_anomaly_score}',\
    setvar:'tx.xss_score=+%{tx.critical_anomaly_score}'"

# Rule 1002: Block Command Injection
SecRule ARGS|REQUEST_HEADERS \
    "@rx (?:(?:[\;\|\`]\W*?\bcc|\bwget|\bcurl|\bchmod|\bls|\btelnet|\bgcc|\bperl|\bpython|\bphp|\bruby|\bnode|\bnc|\bnetcat)\b|/(?:etc|proc|dev|var)/)" \
    "id:1002,\
    phase:2,\
    block,\
    msg:'Command Injection Attack',\
    tag:'attack-injection',\
    severity:'CRITICAL',\
    setvar:'tx.anomaly_score=+%{tx.critical_anomaly_score}'"

# Rule 1003: Block Path Traversal
SecRule REQUEST_URI|ARGS \
    "@rx (?:\.{2,}[\\/]|[\\/]\.{2,})" \
    "id:1003,\
    phase:2,\
    block,\
    msg:'Path Traversal Attack',\
    tag:'attack-lfi',\
    severity:'CRITICAL',\
    setvar:'tx.anomaly_score=+%{tx.critical_anomaly_score}'"

# Rule 1004: Block Dangerous File Uploads
SecRule FILES_NAMES|FILES \
    "@rx \.(php|phtml|php3|php4|php5|phps|phar|exe|bat|cmd|com|cgi|pl|asp|aspx|shtml|shtm|fcgi|fpl|jsp|htm|html|wss|js|vbs|ws)$" \
    "id:1004,\
    phase:2,\
    block,\
    msg:'Dangerous File Upload Attempt',\
    tag:'attack-file-upload',\
    severity:'CRITICAL'"

# Rule 1005: Protect Against CSRF
SecRule REQUEST_METHOD "^(POST|PUT|DELETE|PATCH)$" \
    "id:1005,\
    phase:2,\
    chain,\
    msg:'CSRF Attack - Missing Origin/Referer Header',\
    tag:'attack-csrf',\
    severity:'WARNING'"
    SecRule &REQUEST_HEADERS:Origin "@eq 0" \
        "chain"
        SecRule &REQUEST_HEADERS:Referer "@eq 0" \
            "setvar:'tx.anomaly_score=+%{tx.warning_anomaly_score}'"

# Rule 1006: Block Admin Interface Access
SecRule REQUEST_URI \
    "@rx ^/(?:admin|administrator|wp-admin|phpmyadmin|pma|dbadmin|mysql|myadmin)" \
    "id:1006,\
    phase:1,\
    block,\
    msg:'Admin Interface Access Attempt',\
    tag:'attack-admin',\
    severity:'WARNING'"

# Rule 1007: API Rate Limiting Helper
SecRule REQUEST_URI \
    "@beginsWith /api/" \
    "id:1007,\
    phase:1,\
    pass,\
    nolog,\
    setvar:'tx.api_request=1'"

# Rule 1008: Block Suspicious User Agents
SecRule REQUEST_HEADERS:User-Agent \
    "@rx (?:bot|crawler|spider|scraper|scan|nikto|nmap|masscan|wpscan|sqlmap|havij|acunetix)" \
    "id:1008,\
    phase:1,\
    block,\
    msg:'Suspicious User-Agent',\
    tag:'attack-scanner',\
    severity:'NOTICE'"

# Rule 1009: Enforce Content-Type for API
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:1009,\
    phase:1,\
    chain,\
    msg:'API Request Missing Content-Type',\
    tag:'api-security',\
    severity:'WARNING'"
    SecRule REQUEST_METHOD "^(POST|PUT|PATCH)$" \
        "chain"
        SecRule REQUEST_HEADERS:Content-Type "!@rx ^application/json" \
            "block"

# Rule 1010: Protect Sensitive Data in Responses
SecRule RESPONSE_BODY \
    "@rx (?:(?:password|passwd|pwd|secret|token|api[_-]?key|private[_-]?key|access[_-]?key)[\s]*[:=])" \
    "id:1010,\
    phase:4,\
    block,\
    msg:'Sensitive Data Leak in Response',\
    tag:'data-leak',\
    severity:'CRITICAL'"

# Rule 1011: Block XML External Entity (XXE) Attacks
SecRule REQUEST_HEADERS:Content-Type "@rx ^text/xml|application/xml" \
    "id:1011,\
    phase:2,\
    chain,\
    msg:'XXE Attack Attempt',\
    tag:'attack-xxe',\
    severity:'CRITICAL'"
    SecRule REQUEST_BODY "@rx <!(?:DOCTYPE|ENTITY)[^>]*?(?:SYSTEM|PUBLIC)" \
        "block"

# Rule 1012: Enforce JSON Structure for API
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:1012,\
    phase:2,\
    chain,\
    msg:'Invalid JSON in API Request',\
    tag:'api-validation',\
    severity:'WARNING'"
    SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \
        "chain"
        SecRule REQUEST_BODY "!@rx ^[\{\[].*[\}\]]$" \
            "block"

# Rule 1013: Block Shellshock
SecRule REQUEST_HEADERS|REQUEST_LINE \
    "@rx \(\s*\)\s*\{" \
    "id:1013,\
    phase:1,\
    block,\
    msg:'Shellshock Attack Attempt',\
    tag:'attack-shellshock',\
    severity:'CRITICAL'"

# Rule 1014: Restrict HTTP Methods
SecRule REQUEST_METHOD "!@within %{tx.allowed_methods}" \
    "id:1014,\
    phase:1,\
    block,\
    msg:'Method Not Allowed',\
    tag:'policy-violation',\
    severity:'WARNING'"

# Rule 1015: Log Large File Uploads
SecRule REQUEST_HEADERS:Content-Length "@gt 10485760" \
    "id:1015,\
    phase:1,\
    pass,\
    log,\
    msg:'Large File Upload Detected',\
    tag:'monitoring',\
    severity:'INFO'"

#############################################
# ANOMALY SCORING
#############################################

# Anomaly Score Levels
SecAction \
    "id:900100,\
    phase:1,\
    nolog,\
    pass,\
    t:none,\
    setvar:tx.critical_anomaly_score=5,\
    setvar:tx.error_anomaly_score=4,\
    setvar:tx.warning_anomaly_score=3,\
    setvar:tx.notice_anomaly_score=2"

# Blocking based on anomaly score
SecRule TX:ANOMALY_SCORE "@ge %{tx.inbound_anomaly_score_threshold}" \
    "id:949110,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Inbound Anomaly Score Exceeded (Total Score: %{TX.ANOMALY_SCORE})',\
    tag:'anomaly-evaluation',\
    severity:'CRITICAL'"

# Initialize anomaly score
SecAction \
    "id:901100,\
    phase:1,\
    nolog,\
    pass,\
    setvar:tx.anomaly_score=0"