<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fine Print AI - SSO Authentication</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 3rem;
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 400px;
            width: 90%;
        }
        
        .logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 2rem;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            margin: 2rem auto;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            margin: 1rem 0;
            font-size: 1.1rem;
        }
        
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .success {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .details {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 1rem;
        }
        
        .retry-button {
            background: white;
            color: #667eea;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 1rem;
            transition: all 0.2s ease;
        }
        
        .retry-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">FP</div>
        
        <h2>Authentication in Progress</h2>
        
        <div id="loading-state">
            <div class="spinner"></div>
            <div class="status" id="status">Processing authentication...</div>
        </div>
        
        <div id="error-state" style="display: none;">
            <div class="error" id="error-message"></div>
            <button class="retry-button" onclick="retryAuthentication()">Retry</button>
        </div>
        
        <div id="success-state" style="display: none;">
            <div class="success" id="success-message"></div>
            <div class="details">You can close this window.</div>
        </div>
    </div>

    <script>
        (function() {
            let authData = null;
            let authType = null;

            // Update status message
            function updateStatus(message) {
                document.getElementById('status').textContent = message;
            }

            // Show error state
            function showError(message, details = '') {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-message').innerHTML = `
                    <strong>Authentication Failed</strong><br>
                    ${message}
                    ${details ? `<br><small>${details}</small>` : ''}
                `;
            }

            // Show success state
            function showSuccess(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('success-state').style.display = 'block';
                document.getElementById('success-message').innerHTML = `
                    <strong>Authentication Successful!</strong><br>
                    ${message}
                `;

                // Auto-close after 3 seconds
                setTimeout(() => {
                    window.close();
                }, 3000);
            }

            // Send message to extension
            function sendToExtension(messageName, data) {
                if (chrome && chrome.runtime) {
                    chrome.runtime.sendMessage({
                        name: messageName,
                        body: data
                    }).catch(console.error);
                }
            }

            // Parse URL parameters
            function parseURLParams() {
                const params = new URLSearchParams(window.location.search);
                const fragment = new URLSearchParams(window.location.hash.substring(1));
                
                return {
                    // OAuth parameters
                    code: params.get('code') || fragment.get('code'),
                    state: params.get('state') || fragment.get('state'),
                    error: params.get('error') || fragment.get('error'),
                    error_description: params.get('error_description') || fragment.get('error_description'),
                    
                    // SAML parameters
                    SAMLResponse: params.get('SAMLResponse'),
                    RelayState: params.get('RelayState')
                };
            }

            // Detect authentication provider
            function detectAuthProvider(params) {
                if (params.SAMLResponse) return 'SAML';
                if (params.code && window.location.hostname.includes('accounts.google.com')) return 'GOOGLE_WORKSPACE';
                if (params.code && window.location.hostname.includes('login.microsoftonline.com')) return 'AZURE_AD';
                if (params.code) return 'OIDC';
                return 'UNKNOWN';
            }

            // Process SAML response
            function processSAMLResponse(samlResponse, relayState) {
                updateStatus('Processing SAML response...');
                
                try {
                    // Basic validation
                    if (!samlResponse) {
                        throw new Error('No SAML response received');
                    }

                    // Decode the response to check if it's valid
                    const decoded = atob(samlResponse);
                    if (!decoded.includes('saml')) {
                        throw new Error('Invalid SAML response format');
                    }

                    authData = {
                        samlResponse: samlResponse,
                        relayState: relayState,
                        timestamp: Date.now()
                    };

                    authType = 'SAML_RESPONSE';
                    
                    sendToExtension('SAML_RESPONSE', authData);
                    showSuccess('SAML authentication completed successfully.');
                    
                } catch (error) {
                    showError('Failed to process SAML response', error.message);
                }
            }

            // Process OAuth callback
            function processOAuthCallback(params, provider) {
                updateStatus(`Processing ${provider} authentication...`);
                
                try {
                    if (params.error) {
                        throw new Error(params.error_description || params.error);
                    }

                    if (!params.code) {
                        throw new Error('No authorization code received');
                    }

                    authData = {
                        code: params.code,
                        state: params.state,
                        provider: provider,
                        timestamp: Date.now()
                    };

                    authType = `${provider}_CALLBACK`;
                    
                    sendToExtension(authType, authData);
                    showSuccess(`${provider} authentication completed successfully.`);
                    
                } catch (error) {
                    showError(`${provider} authentication failed`, error.message);
                }
            }

            // Retry authentication
            window.retryAuthentication = function() {
                if (authData && authType) {
                    document.getElementById('error-state').style.display = 'none';
                    document.getElementById('loading-state').style.display = 'block';
                    updateStatus('Retrying authentication...');
                    
                    setTimeout(() => {
                        sendToExtension(authType, authData);
                    }, 1000);
                } else {
                    window.location.reload();
                }
            };

            // Main processing
            function processAuthentication() {
                updateStatus('Analyzing authentication response...');
                
                const params = parseURLParams();
                console.log('Parsed URL params:', params);

                // Check for errors first
                if (params.error) {
                    showError(
                        'Authentication was denied or failed',
                        params.error_description || params.error
                    );
                    return;
                }

                const provider = detectAuthProvider(params);
                console.log('Detected provider:', provider);

                switch (provider) {
                    case 'SAML':
                        processSAMLResponse(params.SAMLResponse, params.RelayState);
                        break;
                        
                    case 'GOOGLE_WORKSPACE':
                        processOAuthCallback(params, 'GOOGLE_WORKSPACE');
                        break;
                        
                    case 'AZURE_AD':
                        processOAuthCallback(params, 'AZURE_AD');
                        break;
                        
                    case 'OIDC':
                        processOAuthCallback(params, 'OIDC');
                        break;
                        
                    default:
                        showError(
                            'Unknown authentication provider',
                            'The authentication response format is not recognized'
                        );
                }
            }

            // Handle messages from parent window (for popup scenarios)
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'AUTH_RESULT') {
                    if (event.data.success) {
                        showSuccess('Authentication completed successfully.');
                    } else {
                        showError('Authentication failed', event.data.error);
                    }
                }
            });

            // Start processing when page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Add a small delay to ensure the page is fully rendered
                setTimeout(processAuthentication, 500);
            });

            // Handle cases where DOMContentLoaded already fired
            if (document.readyState === 'loading') {
                // Already handled above
            } else {
                setTimeout(processAuthentication, 500);
            }

            // Fallback: if nothing happens within 10 seconds, show error
            setTimeout(function() {
                if (document.getElementById('loading-state').style.display !== 'none') {
                    showError(
                        'Authentication timeout',
                        'No valid authentication response was detected'
                    );
                }
            }, 10000);

        })();
    </script>
</body>
</html>