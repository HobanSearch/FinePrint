# PgBouncer Configuration for Fine Print AI
# High-performance connection pooling for millions of users
# Optimized for mixed read/write workloads with burst capacity

[databases]
# Production database configuration
fineprintai = host=postgres-primary port=5432 dbname=fineprintai user=fineprintai_app password=

# Read replica for analytics and reporting queries
fineprintai_readonly = host=postgres-replica port=5432 dbname=fineprintai user=fineprintai_readonly password=

# Test database for development
fineprintai_test = host=postgres-test port=5432 dbname=fineprintai_test user=fineprintai_app password=

[pgbouncer]
# Connection pooling settings optimized for web application workload

# Pooling mode - transaction pooling for maximum efficiency
pool_mode = transaction

# Connection limits - tuned for high-concurrency web app
max_client_conn = 10000          # Maximum client connections
default_pool_size = 100          # Default pool size per database
min_pool_size = 10               # Minimum connections to maintain
reserve_pool_size = 20           # Reserved connections for superuser/emergency
reserve_pool_timeout = 5         # Timeout for reserve pool (seconds)

# Connection lifecycle
server_lifetime = 3600           # Maximum server connection lifetime (1 hour)
server_idle_timeout = 600        # Close server connections idle for 10 minutes
server_connect_timeout = 15      # Timeout for connecting to server
server_login_retry = 15          # Retry server connection every 15 seconds

# Client connection handling
client_idle_timeout = 0          # Don't timeout client connections (handled by app)
client_login_timeout = 60        # Client must login within 60 seconds
autodb_idle_timeout = 3600       # Close unused autodatabases after 1 hour

# Query timeouts
query_timeout = 300              # Maximum query time (5 minutes)
query_wait_timeout = 120         # Maximum time to wait for connection (2 minutes)
cancel_wait_timeout = 10         # Time to wait for cancel query

# Network and performance settings
listen_addr = 0.0.0.0            # Listen on all interfaces
listen_port = 6432               # Standard PgBouncer port
listen_backlog = 4096            # Socket listen backlog

# TCP settings for high throughput
so_reuseport = 1                 # Enable SO_REUSEPORT for better performance
tcp_keepalive = 1                # Enable TCP keepalive
tcp_keepcnt = 9                  # Number of keepalive probes
tcp_keepidle = 7200              # Time before sending keepalive probes
tcp_keepintvl = 75               # Interval between keepalive probes
tcp_user_timeout = 30000         # Total time for unacknowledged data (30s)

# Buffer sizes for high-performance workloads
pkt_buf = 8192                   # Packet buffer size
max_packet_size = 2147483647     # Maximum packet size (2GB)
sbuf_loopcnt = 20                # How many times to try to send data

# Security settings
auth_type = md5                  # Use MD5 authentication
auth_file = /etc/pgbouncer/userlist.txt
auth_query = SELECT username, password FROM auth.users WHERE username = $1

# Admin interface
admin_users = fineprintai_admin, postgres
stats_users = fineprintai_stats, fineprintai_monitor

# SSL/TLS configuration for production
server_tls_sslmode = prefer       # Use TLS when available for backend connections
server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
server_tls_key_file = /etc/pgbouncer/server.key
server_tls_cert_file = /etc/pgbouncer/server.crt
server_tls_protocols = secure     # Only secure TLS versions
server_tls_ciphers = ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS

# Client TLS settings
client_tls_sslmode = allow        # Allow TLS for client connections
client_tls_key_file = /etc/pgbouncer/client.key
client_tls_cert_file = /etc/pgbouncer/client.crt
client_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
client_tls_ciphers = ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS

# Logging configuration
syslog = 1                       # Enable syslog
syslog_facility = daemon         # Syslog facility
syslog_ident = pgbouncer         # Syslog identifier

# Log verbosity (0=fatal, 1=error, 2=warning, 3=info, 4=debug)
log_connections = 1              # Log new connections
log_disconnections = 1           # Log disconnections
log_pooler_errors = 1            # Log pooler errors
log_stats = 1                    # Log statistics
verbose = 1                      # General verbosity level

# Application name tracking
application_name_add_host = 1    # Add hostname to application name
track_extra_parameters = IntervalStyle,TimeZone,DateStyle,search_path

# Health check and maintenance
server_check_delay = 30          # Time between backend health checks
server_check_query = SELECT 1    # Health check query
server_fast_close = 1            # Fast close for idle connections

# Statistics and monitoring
stats_period = 60                # Statistics collection period (seconds)

# Advanced settings for high-load scenarios
disable_pqexec = 0               # Keep pqexec enabled for compatibility
max_prepared_statements = 0      # Disable prepared statement pooling in transaction mode

# Memory management
conffile = /etc/pgbouncer/pgbouncer.ini
pidfile = /var/run/pgbouncer/pgbouncer.pid

# User and permissions
user = pgbouncer
unix_socket_dir = /var/run/pgbouncer
unix_socket_mode = 0777
unix_socket_group = pgbouncer

# Ignore startup parameters that might cause issues
ignore_startup_parameters = extra_float_digits,geqo,search_path