# Kong Declarative Configuration for Fine Print AI
# This file defines the complete API Gateway setup

_format_version: "3.0"
_transform: true

# Services - Backend microservices
services:
  # Analysis Service
  - name: analysis-service
    url: http://analysis-service:3001
    protocol: http
    host: analysis-service
    port: 3001
    path: /
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    tags:
      - fineprintai
      - analysis

  # Monitoring Service
  - name: monitoring-service
    url: http://monitoring-service:3002
    protocol: http
    host: monitoring-service
    port: 3002
    path: /
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    tags:
      - fineprintai
      - monitoring

  # Notification Service
  - name: notification-service
    url: http://notification-service:3003
    protocol: http
    host: notification-service
    port: 3003
    path: /
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    tags:
      - fineprintai
      - notification

  # Action Service
  - name: action-service
    url: http://action-service:3004
    protocol: http
    host: action-service
    port: 3004
    path: /
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    tags:
      - fineprintai
      - action

  # User Service
  - name: user-service
    url: http://user-service:3005
    protocol: http
    host: user-service
    port: 3005
    path: /
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    tags:
      - fineprintai
      - user

  # WebSocket Service
  - name: websocket-service
    url: http://websocket-service:3006
    protocol: http
    host: websocket-service
    port: 3006
    path: /
    retries: 3
    connect_timeout: 60000
    write_timeout: 60000
    read_timeout: 60000
    tags:
      - fineprintai
      - websocket

# Routes - API endpoints
routes:
  # Analysis Service Routes
  - name: analysis-api-v1
    service: analysis-service
    protocols:
      - http
      - https
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
    paths:
      - /api/v1/analysis
    strip_path: false
    preserve_host: false
    tags:
      - fineprintai
      - analysis
      - api-v1

  # Monitoring Service Routes
  - name: monitoring-api-v1
    service: monitoring-service
    protocols:
      - http
      - https
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
    paths:
      - /api/v1/monitoring
      - /api/v1/documents/*/monitor
    strip_path: false
    preserve_host: false
    tags:
      - fineprintai
      - monitoring
      - api-v1

  # Notification Service Routes
  - name: notification-api-v1
    service: notification-service
    protocols:
      - http
      - https
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
    paths:
      - /api/v1/notifications
      - /api/v1/preferences
    strip_path: false
    preserve_host: false
    tags:
      - fineprintai
      - notification
      - api-v1

  # Action Service Routes
  - name: action-api-v1
    service: action-service
    protocols:
      - http
      - https
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
    paths:
      - /api/v1/actions
      - /api/v1/templates
    strip_path: false
    preserve_host: false
    tags:
      - fineprintai
      - action
      - api-v1

  # User Service Routes
  - name: user-api-v1
    service: user-service
    protocols:
      - http
      - https
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
      - OPTIONS
    paths:
      - /api/v1/auth
      - /api/v1/users
      - /api/v1/teams
      - /api/v1/api-keys
    strip_path: false
    preserve_host: false
    tags:
      - fineprintai
      - user
      - api-v1

  # WebSocket Routes
  - name: websocket-api
    service: websocket-service
    protocols:
      - http
      - https
      - ws
      - wss
    paths:
      - /ws
      - /socket.io
    strip_path: false
    preserve_host: false
    tags:
      - fineprintai
      - websocket

  # Health Check Routes (bypass rate limiting)
  - name: health-checks
    service: analysis-service
    protocols:
      - http
      - https
    methods:
      - GET
    paths:
      - /health
      - /ready
      - /metrics
    strip_path: false
    preserve_host: false
    tags:
      - fineprintai
      - health

# Consumers - API consumers (users, applications)
consumers:
  # Free Tier Consumer
  - username: free-tier
    tags:
      - tier-free
      - fineprintai

  # Starter Tier Consumer
  - username: starter-tier
    tags:
      - tier-starter
      - fineprintai

  # Professional Tier Consumer
  - username: professional-tier
    tags:
      - tier-professional
      - fineprintai

  # Team Tier Consumer
  - username: team-tier
    tags:
      - tier-team
      - fineprintai

  # Enterprise Tier Consumer
  - username: enterprise-tier
    tags:
      - tier-enterprise
      - fineprintai

# Plugins - Kong plugins for security, rate limiting, etc.
plugins:
  # CORS Plugin - Global
  - name: cors
    config:
      origins:
        - "http://localhost:3000"
        - "https://app.fineprintai.com"
        - "https://fineprintai.com"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - Authorization
        - X-API-Key
        - X-Request-ID
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
      credentials: true
      max_age: 3600
      preflight_continue: false
    tags:
      - fineprintai
      - security

  # Request ID Plugin - Global
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true
    tags:
      - fineprintai
      - logging

  # Security Headers Plugin - Global
  - name: response-transformer
    config:
      add:
        headers:
          - "X-Content-Type-Options:nosniff"
          - "X-Frame-Options:DENY"
          - "X-XSS-Protection:1; mode=block"
          - "Referrer-Policy:strict-origin-when-cross-origin"
          - "Content-Security-Policy:default-src 'self'"
    tags:
      - fineprintai
      - security

  # Rate Limiting - Global (Basic)
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      day: 10000
      policy: redis
      redis_host: redis
      redis_port: 6379
      redis_timeout: 2000
      fault_tolerant: true
      hide_client_headers: false
    tags:
      - fineprintai
      - rate-limiting

  # Rate Limiting - Analysis Endpoint (Stricter)
  - name: rate-limiting
    route: analysis-api-v1
    config:
      minute: 20
      hour: 200
      day: 1000
      policy: redis
      redis_host: redis
      redis_port: 6379
      redis_timeout: 2000
      fault_tolerant: true
      header_name: X-RateLimit-Analysis
    tags:
      - fineprintai
      - rate-limiting
      - analysis

  # IP Restriction Plugin - Admin endpoints
  - name: ip-restriction
    config:
      allow:
        - "10.0.0.0/8"
        - "172.16.0.0/12"
        - "192.168.0.0/16"
        - "127.0.0.1"
    tags:
      - fineprintai
      - security
      - admin

  # Request Size Limiting
  - name: request-size-limiting
    config:
      allowed_payload_size: 50
    tags:
      - fineprintai
      - security

  # Bot Detection
  - name: bot-detection
    config:
      allow:
        - "googlebot"
        - "bingbot"
      deny:
        - "curl"
        - "wget"
        - "python-requests"
    tags:
      - fineprintai
      - security

  # Request Termination for Health Checks (No Auth Required)
  - name: request-termination
    route: health-checks
    config:
      status_code: 200
      message: "Service is healthy"
    enabled: false
    tags:
      - fineprintai
      - health

  # JWT Authentication - API routes
  - name: jwt
    route: analysis-api-v1
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      claims_to_verify:
        - exp
        - sub
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: true
    tags:
      - fineprintai
      - auth

  - name: jwt
    route: monitoring-api-v1
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      claims_to_verify:
        - exp
        - sub
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: true
    tags:
      - fineprintai
      - auth

  - name: jwt
    route: notification-api-v1
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      claims_to_verify:
        - exp
        - sub
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: true
    tags:
      - fineprintai
      - auth

  - name: jwt
    route: action-api-v1
    config:
      uri_param_names:
        - jwt
      cookie_names:
        - jwt
      claims_to_verify:
        - exp
        - sub
      key_claim_name: iss
      secret_is_base64: false
      run_on_preflight: true
    tags:
      - fineprintai
      - auth

  # Prometheus Metrics
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
    tags:
      - fineprintai
      - metrics

  # Request/Response Logging
  - name: http-log
    config:
      http_endpoint: "http://loki:3100/loki/api/v1/push"
      method: POST
      timeout: 10000
      keepalive: 60000
      flush_timeout: 2
    tags:
      - fineprintai
      - logging

  # Circuit Breaker
  - name: proxy-cache
    config:
      request_method:
        - GET
        - HEAD
      response_code:
        - 200
        - 301
        - 404
      content_type:
        - "application/json"
      cache_ttl: 300
      strategy: memory
    tags:
      - fineprintai
      - performance

# JWT Credentials (These would be managed dynamically in production)
jwt_secrets:
  - consumer: free-tier
    algorithm: HS256
    key: "fineprintai-free"
    secret: "your-jwt-secret-here"

  - consumer: starter-tier
    algorithm: HS256
    key: "fineprintai-starter"
    secret: "your-jwt-secret-here"

  - consumer: professional-tier
    algorithm: HS256
    key: "fineprintai-professional"
    secret: "your-jwt-secret-here"

  - consumer: team-tier
    algorithm: HS256
    key: "fineprintai-team"
    secret: "your-jwt-secret-here"

  - consumer: enterprise-tier
    algorithm: HS256
    key: "fineprintai-enterprise"
    secret: "your-jwt-secret-here"