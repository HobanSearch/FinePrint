# Kong Gateway Configuration for Fine Print AI
# Production-ready configuration with security hardening

# Basic Configuration
database = off
declarative_config = /etc/kong/declarative/kong.yml
proxy_listen = 0.0.0.0:8000, 0.0.0.0:8443 ssl
admin_listen = 0.0.0.0:8001, 0.0.0.0:8444 ssl
status_listen = 0.0.0.0:8100

# SSL Configuration
ssl_cert = /etc/kong/ssl/kong.crt
ssl_cert_key = /etc/kong/ssl/kong.key
admin_ssl_cert = /etc/kong/ssl/admin.crt
admin_ssl_cert_key = /etc/kong/ssl/admin.key

# Security Settings
admin_gui_auth = basic-auth
admin_gui_session_conf = {"secret":"fineprintai-admin-secret","storage":"kong","cookie_secure":true}
nginx_admin_directive = add_header X-Frame-Options DENY; add_header X-Content-Type-Options nosniff;

# Performance Tuning
nginx_worker_processes = auto
nginx_events_worker_connections = 4096
mem_cache_size = 256m
upstream_keepalive_pool_size = 60
upstream_keepalive_max_requests = 100
upstream_keepalive_idle_timeout = 60s

# Logging
log_level = info
proxy_access_log = /dev/stdout
admin_access_log = /dev/stdout
proxy_error_log = /dev/stderr
admin_error_log = /dev/stderr
anonymous_reports = false

# Custom Plugins
plugins = bundled,custom-auth,custom-rate-limit,custom-circuit-breaker,custom-jwt-refresh
lua_package_path = /opt/kong/plugins/custom/?.lua;/opt/kong/plugins/custom/?/init.lua;;

# Rate Limiting
nginx_http_lua_shared_dict = kong_rate_limiting_counters 12m
nginx_http_lua_shared_dict = kong_db_cache 128m

# Circuit Breaker
nginx_http_lua_shared_dict = kong_circuit_breaker 10m

# Real IP Configuration (for load balancers)
real_ip_header = X-Forwarded-For
trusted_ips = 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,127.0.0.1

# Headers
headers = server_tokens=off,latency_tokens=on

# Admin API Security
admin_gui_url = https://admin.fineprintai.com
admin_api_uri = https://admin-api.fineprintai.com

# Cluster Settings (for multi-node deployment)
cluster_listen = 0.0.0.0:8005
cluster_cert = /etc/kong/ssl/cluster.crt
cluster_cert_key = /etc/kong/ssl/cluster.key

# DNS Resolution
dns_resolver = 8.8.8.8,8.8.4.4,1.1.1.1
dns_hostsfile = /etc/hosts
dns_order = LAST,SRV,A,AAAA

# Client SSL
client_ssl = on
client_ssl_cert_default = /etc/kong/ssl/client.crt
client_ssl_cert_key_default = /etc/kong/ssl/client.key

# Proxy Settings
proxy_ssl_verify = on
lua_ssl_verify_depth = 3
lua_ssl_trusted_certificate = /etc/ssl/certs/ca-certificates.crt

# Stream Module (for TCP/UDP proxying)
stream_listen = 0.0.0.0:9000, 0.0.0.0:9443 ssl

# Status API
status_access_log = off
status_error_log = /dev/stderr

# Nginx Optimizations
nginx_http_client_max_body_size = 50m
nginx_http_client_body_buffer_size = 8k
nginx_proxy_proxy_buffer_size = 16k
nginx_proxy_proxy_buffers = 8 16k